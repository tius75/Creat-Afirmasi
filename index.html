<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembuat Afirmasi</title>

       <link rel="manifest" href="./manifest.json">

  <meta name="theme-color" content="#D30000">

  <link rel="apple-touch-icon" href="logo192.png">

  <link rel="icon" type="image/png" href="favicon32.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Mengimpor font Inter dari Google Fonts untuk tipografi yang bersih */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Kelas untuk mempertahankan rasio aspek 16:9 */
        .aspect-ratio-16-9 {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 9 / 16 * 100 */
            overflow: hidden;
        }
        /* Memastikan elemen di dalam .aspect-ratio-16-9 mengisi seluruh ruang */
        .aspect-ratio-16-9 > * {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Untuk gambar/video agar mengisi tanpa distorsi */
        }
        /* Gaya untuk bagian teks afirmasi di bawah media */
        .affirmation-text-section {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 9 / 16 * 100 */
            overflow: hidden; /* Sembunyikan apapun di luar kotak 16:9 */
        }
        .affirmation-text-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Pusatkan konten secara vertikal */
            align-items: center; /* Pusatkan konten secara horizontal */
            padding: 1.5rem; /* Padding untuk ruang di sekitar teks */
            box-sizing: border-box; /* Memastikan padding termasuk dalam lebar/tinggi */
            text-align: center; /* Pusatkan teks secara horizontal */
        }
        /* Memastikan teks tidak terpotong dan memecah kata jika terlalu panjang */
        .affirmation-text-content h2,
        .affirmation-text-content p {
            word-break: break-word; /* Memecah kata panjang */
            overflow-wrap: break-word; /* Versi modern dari word-break */
            line-height: 1.2; /* Mengurangi tinggi baris untuk menghemat ruang */
        }
        .affirmation-text-content h2 {
            margin-bottom: 0.5rem; /* Sedikit margin bawah untuk judul */
        }
        .affirmation-text-content p {
            margin-bottom: 0; /* Hapus margin bawah untuk paragraf terakhir */
        }
        /* Gaya untuk thumbnail Pexels */
        .pexels-thumbnail {
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .pexels-thumbnail.selected {
            border-color: #10B981; /* green-500 */
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.5); /* green-500 with opacity */
        }
    </style>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1A202C">
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
    <div class="max-w-6xl w-full bg-white p-6 rounded-lg shadow-xl mb-8 grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Buat Kartu Afirmasi Anda</h1>

            <form id="affirmationForm" class="space-y-4">
                <div>
                    <label for="titleInput" class="block text-sm font-medium text-gray-700">Judul Afirmasi:</label>
                    <input type="text" id="titleInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Masukkan judul afirmasi Anda" required>
                </div>
                <div>
                    <label for="contentInput" class="block text-sm font-medium text-gray-700">Isi Afirmasi:</label>
                    <textarea id="contentInput" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Masukkan isi afirmasi Anda" required></textarea>
                </div>

                <div class="border-t border-gray-200 pt-4 mt-4">
                    <p class="text-sm font-semibold text-gray-800 mb-3">Pilih Sumber Media:</p>
                    <div class="flex flex-wrap gap-3 mb-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="mediaSource" value="url" class="form-radio text-blue-600" checked>
                            <span class="ml-2 text-gray-700">URL Eksternal (Gambar/YouTube)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="mediaSource" value="local" class="form-radio text-blue-600">
                            <span class="ml-2 text-gray-700">Unggah Lokal</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="mediaSource" value="picsum" class="form-radio text-blue-600">
                            <span class="ml-2 text-gray-700">Gambar Acak (Picsum)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="mediaSource" value="pexels_image" class="form-radio text-blue-600">
                            <span class="ml-2 text-gray-700">Pexels Gambar Acak</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="mediaSource" value="pexels_video" class="form-radio text-blue-600">
                            <span class="ml-2 text-gray-700">Pexels Video Acak</span>
                        </label>
                    </div>

                    <div id="urlInputSection" class="media-input-section">
                        <label for="mediaUrlInput" class="block text-sm font-medium text-gray-700">URL Gambar atau Video (YouTube):</label>
                        <input type="url" id="mediaUrlInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Contoh: https://i.imgur.com/example.jpg atau https://www.youtube.com/watch?v=dQw4w9WgXcQ">
                    </div>

                    <div id="localInputSection" class="media-input-section hidden">
                        <label for="mediaFileInput" class="block text-sm font-medium text-gray-700">Unggah dari Lokal (Gambar/Video):</label>
                        <input type="file" id="mediaFileInput" accept="image/*,video/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>

                    <div id="picsumInputSection" class="media-input-section hidden">
                        <button type="button" id="generatePicsumBtn" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 shadow-md">
                            Ambil Gambar Acak Picsum
                        </button>
                    </div>

                    <div id="pexelsImageSection" class="media-input-section hidden">
                        <button type="button" id="generatePexelsImageBtn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 shadow-md">
                            Ambil Gambar Acak Pexels
                        </button>
                    </div>

                    <div id="pexelsVideoSection" class="media-input-section hidden">
                        <button type="button" id="generatePexelsVideoBtn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 shadow-md">
                            Ambil Video Acak Pexels
                        </button>
                    </div>

                    <div id="selectedMediaPreview" class="mt-4 hidden">
                        <p class="text-sm font-medium text-gray-700 mb-2">Media Terpilih:</p>
                        <div class="relative aspect-ratio-16-9 rounded-md overflow-hidden border border-gray-300">
                            <img id="selectedMediaThumbnail" class="w-full h-full object-cover" alt="Selected Media Preview" src="https://placehold.co/1280x720/E2E8F0/1A202C?text=Pilih+Media">
                            <div id="selectedMediaOverlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white text-3xl hidden">
                                â–º </div>
                        </div>
                        <p id="selectedMediaName" class="text-xs text-gray-500 mt-1 text-center"></p>
                    </div>

                    <p id="pexelsLoading" class="text-center text-blue-500 hidden mt-2">Memuat media...</p>
                    <p id="pexelsError" class="text-center text-red-500 hidden mt-2">Gagal memuat media Pexels.</p>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-md">
                    Buat Kartu
                </button>
            </form>
        </div>

        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Pratinjau Teks Afirmasi</h2>
            <div class="bg-white p-4 rounded-md shadow-inner h-full min-h-[200px] flex flex-col justify-center items-center text-center">
                <p id="previewTitle" class="text-xl font-bold text-gray-900 mb-2"></p>
                <p id="previewContent" class="text-gray-700"></p>
                <p id="previewPlaceholder" class="text-gray-400 italic">Tulis afirmasi Anda di kiri untuk melihat pratinjau.</p>
            </div>
        </div>
    </div>

    <div id="affirmationCardContainer" class="w-full max-w-xl bg-gray-900 rounded-lg shadow-2xl overflow-hidden hidden">
        <div class="aspect-ratio-16-9 relative">
            <div id="mediaDisplay" class="absolute inset-0 flex items-center justify-center bg-gray-800">
                </div>
        </div>
        <div class="affirmation-text-section">
            <div id="affirmationTextContent" class="affirmation-text-content bg-white text-gray-900">
                <h2 id="cardTitle" class="font-bold mb-2"></h2>
                <p id="cardContent"></p>
            </div>
        </div>
        <div class="bg-gray-800 text-gray-400 text-center py-2 text-sm">
            Dibuat oleh Tius
        </div>
    </div>

    <button id="downloadCardBtn" class="mt-6 bg-green-600 text-white py-3 px-6 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 shadow-md hidden">
        Unduh Kartu Afirmasi (Gambar PNG)
    </button>
    <p id="downloadWarning" class="text-sm text-red-700 font-bold mt-2 text-center hidden">
        *PENTING: Unduhan kartu afirmasi akan selalu berupa GAMBAR PNG. Video (dari YouTube, lokal, atau Pexels) tidak dapat disertakan dalam unduhan gambar ini karena batasan browser.
    </p>

    <button id="downloadOriginalVideoBtn" class="mt-4 bg-blue-600 text-white py-3 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-md hidden">
        Unduh Video Asli
    </button>


    <script>
        // Memastikan DOM telah dimuat sepenuhnya sebelum menjalankan skrip
        document.addEventListener('DOMContentLoaded', () => {
            // Mendapatkan referensi ke elemen-elemen DOM yang dibutuhkan
            const form = document.getElementById('affirmationForm');
            const titleInput = document.getElementById('titleInput');
            const contentInput = document.getElementById('contentInput');
            const mediaUrlInput = document.getElementById('mediaUrlInput');
            const mediaFileInput = document.getElementById('mediaFileInput');
            const affirmationCardContainer = document.getElementById('affirmationCardContainer');
            const mediaDisplay = document.getElementById('mediaDisplay');
            const affirmationTextContent = document.getElementById('affirmationTextContent');
            const cardTitle = document.getElementById('cardTitle');
            const cardContent = document.getElementById('cardContent');
            const previewTitle = document.getElementById('previewTitle');
            const previewContent = document.getElementById('previewContent');
            const previewPlaceholder = document.getElementById('previewPlaceholder');
            const downloadCardBtn = document.getElementById('downloadCardBtn');
            const downloadWarning = document.getElementById('downloadWarning');
            const downloadOriginalVideoBtn = document.getElementById('downloadOriginalVideoBtn'); // New button

            // Media Source Selection Elements
            const mediaSourceRadios = document.querySelectorAll('input[name="mediaSource"]');
            const urlInputSection = document.getElementById('urlInputSection');
            const localInputSection = document.getElementById('localInputSection');
            const picsumInputSection = document.getElementById('picsumInputSection');
            const pexelsImageSection = document.getElementById('pexelsImageSection');
            const pexelsVideoSection = document.getElementById('pexelsVideoSection');

            const generatePicsumBtn = document.getElementById('generatePicsumBtn');
            const generatePexelsImageBtn = document.getElementById('generatePexelsImageBtn');
            const generatePexelsVideoBtn = document.getElementById('generatePexelsVideoBtn');

            const selectedMediaPreview = document.getElementById('selectedMediaPreview');
            const selectedMediaThumbnail = document.getElementById('selectedMediaThumbnail');
            const selectedMediaOverlay = document.getElementById('selectedMediaOverlay');
            const selectedMediaName = document.getElementById('selectedMediaName');

            const pexelsLoading = document.getElementById('pexelsLoading');
            const pexelsError = document.getElementById('pexelsError');

            const PEXELS_API_KEY = 'UM6sxKhVbnKYTzkTGbZ3fHW4v5DpJzAynjePGssIle8HIBHbMhAwKaOO';
            let selectedMediaData = { url: '', type: '' }; // To store the selected media URL and type (image/video)

            // Function to show/hide media input sections based on radio selection
            const toggleMediaInputSections = () => {
                const selectedSource = document.querySelector('input[name="mediaSource"]:checked').value;
                [urlInputSection, localInputSection, picsumInputSection, pexelsImageSection, pexelsVideoSection].forEach(section => {
                    section.classList.add('hidden');
                });
                selectedMediaPreview.classList.add('hidden'); // Hide preview when changing source
                selectedMediaData = { url: '', type: '' }; // Reset selected media
                downloadOriginalVideoBtn.classList.add('hidden'); // Hide original video download button
                downloadCardBtn.classList.add('hidden'); // Hide card download button
                downloadWarning.classList.add('hidden'); // Hide warning

                switch (selectedSource) {
                    case 'url':
                        urlInputSection.classList.remove('hidden');
                        break;
                    case 'local':
                        localInputSection.classList.remove('hidden');
                        break;
                    case 'picsum':
                        picsumInputSection.classList.remove('hidden');
                        break;
                    case 'pexels_image':
                        pexelsImageSection.classList.remove('hidden');
                        break;
                    case 'pexels_video':
                        pexelsVideoSection.classList.remove('hidden');
                        break;
                }
            };

            // Add event listeners for media source radio buttons
            mediaSourceRadios.forEach(radio => {
                radio.addEventListener('change', toggleMediaInputSections);
            });

            // Initial toggle when page loads
            toggleMediaInputSections();

            // Function to update text preview
            const updatePreview = () => {
                previewTitle.textContent = titleInput.value;
                previewContent.textContent = contentInput.value;
                if (titleInput.value || contentInput.value) {
                    previewPlaceholder.classList.add('hidden');
                } else {
                    previewPlaceholder.classList.remove('hidden');
                }
            };

            // Function to adjust font size dynamically
            const adjustFontSize = () => {
                // Reset font sizes to a large initial value (in px)
                let currentTitleSize = 40;
                let currentContentSize = 24;

                // Set minimum font sizes (in px)
                const minTitleSize = 14;
                const minContentSize = 10;

                // Get available dimensions for text content, considering padding
                const availableWidth = affirmationTextContent.offsetWidth - (parseFloat(getComputedStyle(affirmationTextContent).paddingLeft) + parseFloat(getComputedStyle(affirmationTextContent).paddingRight));
                const availableHeight = affirmationTextContent.offsetHeight - (parseFloat(getComputedStyle(affirmationTextContent).paddingTop) + parseFloat(getComputedStyle(affirmationTextContent).paddingBottom));

                // Apply initial sizes
                cardTitle.style.fontSize = `${currentTitleSize}px`;
                cardContent.style.fontSize = `${currentContentSize}px`;

                let attempts = 0;
                const maxAttempts = 300; // Increased attempts for more aggressive shrinking

                while (attempts < maxAttempts) {
                    attempts++;

                    // Measure dimensions after applying current font sizes
                    const titleHeight = cardTitle.clientHeight;
                    const contentHeight = cardContent.clientHeight;
                    const totalTextHeight = titleHeight + contentHeight + (cardTitle.textContent ? parseFloat(getComputedStyle(cardTitle).marginBottom) : 0);

                    const titleWidth = cardTitle.clientWidth;
                    const contentWidth = cardContent.clientWidth;

                    // Check if all text fits both vertically and horizontally
                    const combinedHeightFits = totalTextHeight <= availableHeight;
                    const titleFitsHorizontally = titleWidth <= availableWidth;
                    const contentFitsHorizontally = contentWidth <= availableWidth;

                    if (combinedHeightFits && titleFitsHorizontally && contentFitsHorizontally) {
                        break; // All text fits, exit loop
                    }

                    // Shrink logic: prioritize content, then title, then horizontal overflow
                    if (!combinedHeightFits) {
                        if (currentContentSize > minContentSize) {
                            currentContentSize -= 0.5; // Shrink by smaller steps
                        } else if (currentTitleSize > minTitleSize) {
                            currentTitleSize -= 0.5;
                        } else {
                            break; // Cannot shrink further
                        }
                    } else if (!titleFitsHorizontally) {
                        if (currentTitleSize > minTitleSize) {
                            currentTitleSize -= 0.5;
                        } else {
                            break;
                        }
                    } else if (!contentFitsHorizontally) {
                        if (currentContentSize > minContentSize) {
                            currentContentSize -= 0.5;
                        } else {
                            break;
                        }
                    } else {
                        // Fallback for edge cases, if still overflowing for unknown reason
                        if (currentContentSize > minContentSize) {
                            currentContentSize -= 0.5;
                        } else if (currentTitleSize > minTitleSize) {
                            currentTitleSize -= 0.5;
                        } else {
                            break;
                        }
                    }

                    // Apply new sizes for next iteration
                    cardTitle.style.fontSize = `${currentTitleSize}px`;
                    cardContent.style.fontSize = `${currentContentSize}px`;
                }
            };


            // Add event listeners for text inputs to update preview in real-time
            titleInput.addEventListener('input', updatePreview);
            contentInput.addEventListener('input', updatePreview);

            // Picsum Button Logic
            generatePicsumBtn.addEventListener('click', () => {
                const randomId = Math.floor(Math.random() * 1000);
                selectedMediaData = {
                    url: `https://picsum.photos/1280/720?random=${randomId}`, // Use 16:9 ratio
                    type: 'image'
                };
                selectedMediaThumbnail.src = selectedMediaData.url;
                selectedMediaName.textContent = 'Gambar Acak Picsum';
                selectedMediaOverlay.classList.add('hidden');
                selectedMediaPreview.classList.remove('hidden');
                alert('Gambar Picsum acak dipilih. Klik "Buat Kartu" untuk melihatnya.');
            });

            // Pexels Image Button Logic
            generatePexelsImageBtn.addEventListener('click', async () => {
                pexelsLoading.classList.remove('hidden');
                pexelsError.classList.add('hidden');
                selectedMediaPreview.classList.add('hidden'); // Hide preview during loading

                try {
                    // Fetch curated photos (good for random selection), get a larger set
                    const response = await fetch(`https://api.pexels.com/v1/curated?per_page=80&orientation=landscape`, {
                        headers: { 'Authorization': PEXELS_API_KEY }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    pexelsLoading.classList.add('hidden');

                    if (data.photos && data.photos.length > 0) {
                        const randomIndex = Math.floor(Math.random() * data.photos.length);
                        const photo = data.photos[randomIndex]; // Select a random photo from the fetched set
                        selectedMediaData = {
                            url: photo.src.original,
                            type: 'image'
                        };
                        selectedMediaThumbnail.src = photo.src.medium; // Use medium for thumbnail preview
                        selectedMediaName.textContent = `Pexels Gambar oleh ${photo.photographer}`;
                        selectedMediaOverlay.classList.add('hidden');
                        selectedMediaPreview.classList.remove('hidden');
                        alert('Gambar Pexels acak dipilih. Klik "Buat Kartu" untuk melihatnya.');
                    } else {
                        pexelsError.classList.remove('hidden');
                        pexelsError.textContent = 'Tidak ada gambar Pexels acak ditemukan.';
                    }

                } catch (error) {
                    console.error('Error fetching Pexels image:', error);
                    pexelsLoading.classList.add('hidden');
                    pexelsError.classList.remove('hidden');
                    pexelsError.textContent = 'Gagal memuat gambar Pexels acak. Coba lagi.';
                }
            });

            // Pexels Video Button Logic
            generatePexelsVideoBtn.addEventListener('click', async () => {
                pexelsLoading.classList.remove('hidden');
                pexelsError.classList.add('hidden');
                selectedMediaPreview.classList.add('hidden'); // Hide preview during loading

                try {
                    // Fetch popular videos (good for random selection), get a larger set
                    const response = await fetch(`https://api.pexels.com/videos/popular?per_page=80&orientation=landscape`, {
                        headers: { 'Authorization': PEXELS_API_KEY }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    pexelsLoading.classList.add('hidden');

                    if (data.videos && data.videos.length > 0) {
                        const randomIndex = Math.floor(Math.random() * data.videos.length);
                        const video = data.videos[randomIndex]; // Select a random video from the fetched set
                        // Find a suitable video file (e.g., HD 1920, or first available)
                        const videoFile = video.video_files.find(f => f.quality === 'hd' && f.width === 1920)?.link || video.video_files[0]?.link;

                        if (videoFile) {
                            selectedMediaData = {
                                url: videoFile,
                                type: 'video'
                            };
                            selectedMediaThumbnail.src = video.image; // Use video's image as thumbnail
                            selectedMediaName.textContent = `Pexels Video oleh ${video.user.name}`;
                            selectedMediaOverlay.classList.remove('hidden'); // Show play icon
                            selectedMediaPreview.classList.remove('hidden');
                            alert('Video Pexels acak dipilih. Klik "Buat Kartu" untuk melihatnya.');
                        } else {
                            pexelsError.classList.remove('hidden');
                            pexelsError.textContent = 'Tidak ada file video yang cocok ditemukan untuk video Pexels acak ini.';
                        }
                    } else {
                        pexelsError.classList.remove('hidden');
                        pexelsError.textContent = 'Tidak ada video Pexels acak ditemukan.';
                    }

                } catch (error) {
                    console.error('Error fetching Pexels video:', error);
                    pexelsLoading.classList.add('hidden');
                    pexelsError.classList.remove('hidden');
                    pexelsError.textContent = 'Gagal memuat video Pexels acak. Coba lagi.';
                }
            });


            // Add event listener for form submission
            form.addEventListener('submit', (e) => {
                e.preventDefault(); // Prevent page refresh on form submission

                // Get values from inputs
                const title = titleInput.value;
                const content = contentInput.value;
                const selectedSource = document.querySelector('input[name="mediaSource"]:checked').value;

                // Update text on the affirmation card
                cardTitle.textContent = title;
                cardContent.textContent = content;

                mediaDisplay.innerHTML = ''; // Clear previous media

                let mediaLoadedPromise; // Promise to track media loading

                // Hide download buttons and warning initially
                downloadCardBtn.classList.add('hidden');
                downloadWarning.classList.add('hidden');
                downloadOriginalVideoBtn.classList.add('hidden');

                if (selectedSource === 'local') {
                    const mediaFile = mediaFileInput.files[0];
                    if (!mediaFile) {
                        alert('Harap unggah file media lokal.');
                        return;
                    }
                    const fileType = mediaFile.type;
                    const reader = new FileReader();
                    mediaLoadedPromise = new Promise((resolve, reject) => {
                        reader.onloadend = () => {
                            if (fileType.startsWith('image/')) {
                                const img = document.createElement('img');
                                img.src = reader.result;
                                img.alt = 'Local Affirmation Image';
                                img.className = 'w-full h-full object-cover';
                                mediaDisplay.appendChild(img);
                                img.onload = resolve;
                                img.onerror = reject;
                            } else if (fileType.startsWith('video/')) {
                                const video = document.createElement('video');
                                video.src = reader.result;
                                video.controls = false;
                                video.autoplay = true;
                                video.loop = true;
                                video.muted = true;
                                video.playsInline = true;
                                video.className = 'w-full h-full object-cover';
                                mediaDisplay.appendChild(video);
                                video.onloadeddata = resolve;
                                video.onerror = reject;
                            } else {
                                mediaDisplay.innerHTML = '<p class="text-white text-center">Tipe file tidak didukung. Harap unggah gambar atau video.</p>';
                                reject('Unsupported file type');
                            }
                        };
                        reader.readAsDataURL(mediaFile);
                    });
                } else if (selectedSource === 'url') {
                    const mediaUrl = mediaUrlInput.value;
                    if (!mediaUrl) {
                        alert('Harap masukkan URL media.');
                        return;
                    }
                    const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/||v\/)([\w-]{11})(?:\S+)?/;
                    const match = mediaUrl.match(youtubeRegex);

                    if (match && match[1]) {
                        const videoId = match[1];
                        const iframe = document.createElement('iframe');
                        iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=0&loop=1&playlist=${videoId}&enablejsapi=1`;
                        iframe.allow = "autoplay; encrypted-media; picture-in-picture";
                        iframe.setAttribute('frameborder', '0');
                        iframe.setAttribute('allowfullscreen', '');
                        iframe.className = 'w-full h-full';
                        mediaDisplay.appendChild(iframe);
                        mediaLoadedPromise = new Promise(resolve => setTimeout(resolve, 1500));
                    } else {
                        const img = document.createElement('img');
                        img.src = mediaUrl;
                        img.alt = 'Affirmation Image';
                        img.className = 'w-full h-full object-cover';
                        mediaLoadedPromise = new Promise((resolve, reject) => {
                            img.onload = resolve;
                            img.onerror = () => {
                                img.src = 'https://placehold.co/1280x720/E2E8F0/1A202C?text=Gambar+Tidak+Ditemukan';
                                img.alt = 'Gambar Tidak Ditemukan';
                                resolve();
                            };
                            mediaDisplay.appendChild(img);
                        });
                    }
                } else if (selectedSource === 'picsum' || selectedSource === 'pexels_image' || selectedSource === 'pexels_video') {
                    if (!selectedMediaData.url) {
                        alert('Harap hasilkan atau pilih media dari Picsum/Pexels terlebih dahulu.');
                        return;
                    }
                    if (selectedMediaData.type === 'image') {
                        const img = document.createElement('img');
                        img.src = selectedMediaData.url;
                        img.alt = 'Generated Image';
                        img.className = 'w-full h-full object-cover';
                        mediaLoadedPromise = new Promise((resolve, reject) => {
                            img.onload = resolve;
                            img.onerror = () => {
                                img.src = 'https://placehold.co/1280x720/E2E8F0/1A202C?text=Gambar+Tidak+Ditemukan';
                                img.alt = 'Gambar Tidak Ditemukan';
                                resolve();
                            };
                            mediaDisplay.appendChild(img);
                        });
                    } else if (selectedMediaData.type === 'video') {
                        const video = document.createElement('video');
                        video.src = selectedMediaData.url;
                        video.controls = false;
                        video.autoplay = true;
                        video.loop = true;
                        video.muted = true;
                        video.playsInline = true;
                        video.className = 'w-full h-full object-cover';
                        mediaDisplay.appendChild(video);
                        mediaLoadedPromise = new Promise((resolve, reject) => {
                            video.onloadeddata = resolve;
                            video.onerror = reject;
                        });
                    }
                } else {
                    mediaDisplay.innerHTML = '<p class="text-white text-center">Pilih sumber media.</p>';
                    mediaLoadedPromise = Promise.resolve();
                }


                // After media is loaded (or timeout for iframe), adjust font and show card
                mediaLoadedPromise.then(() => {
                    // Wait a very short moment for the browser to render the text elements
                    // before measuring them for font adjustment.
                    setTimeout(() => {
                        adjustFontSize(); // Adjust font size after media is ready
                        affirmationCardContainer.classList.remove('hidden');

                        // Show/hide download buttons based on media type
                        const currentSelectedSource = document.querySelector('input[name="mediaSource"]:checked').value;
                        if (selectedMediaData.type === 'video' && (currentSelectedSource === 'pexels_video' || currentSelectedSource === 'local')) {
                            // If it's a Pexels or local video, show original video download button
                            downloadOriginalVideoBtn.classList.remove('hidden');
                            downloadCardBtn.classList.add('hidden'); // Hide PNG download for videos
                            downloadWarning.classList.remove('hidden'); // Show warning for PNG limitation
                        } else {
                            // For images or YouTube videos, show PNG download button
                            downloadCardBtn.classList.remove('hidden');
                            downloadWarning.classList.remove('hidden'); // Show warning for PNG limitation
                            downloadOriginalVideoBtn.classList.add('hidden');
                        }

                    }, 50); // Small delay
                }).catch(error => {
                    console.error("Media loading error:", error);
                    alert("Gagal memuat media. Pastikan URL benar, file valid, atau Pexels media dipilih.");
                    affirmationCardContainer.classList.add('hidden'); // Hide card if media fails
                    downloadCardBtn.classList.add('hidden');
                    downloadWarning.classList.add('hidden');
                    downloadOriginalVideoBtn.classList.add('hidden');
                });
            });

            // Event listener for download Card (PNG) button
            downloadCardBtn.addEventListener('click', () => {
                // Hide download buttons and warning temporarily so they are not captured
                downloadCardBtn.classList.add('hidden');
                downloadWarning.classList.add('hidden');
                downloadOriginalVideoBtn.classList.add('hidden');

                // Give a short delay for the browser to fully render before taking screenshot
                setTimeout(() => {
                    html2canvas(affirmationCardContainer, {
                        useCORS: true,
                        allowTaint: true,
                        scrollY: -window.scrollY,
                        windowWidth: document.documentElement.offsetWidth,
                        windowHeight: document.documentElement.offsetHeight,
                        scale: 2 // Render at 2x resolution for improved text quality
                    }).then(canvas => {
                        // Create download link
                        const link = document.createElement('a');
                        link.download = 'kartu_afirmasi.png';
                        link.href = canvas.toDataURL('image/png');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        // Show download buttons and warning again
                        downloadCardBtn.classList.remove('hidden');
                        downloadWarning.classList.remove('hidden');
                        // Only show original video download if it was a video
                        const currentSelectedSource = document.querySelector('input[name="mediaSource"]:checked').value;
                        if (selectedMediaData.type === 'video' && (currentSelectedSource === 'pexels_video' || currentSelectedSource === 'local')) {
                             downloadOriginalVideoBtn.classList.remove('hidden');
                        }
                    }).catch(error => {
                        console.error('Gagal mengunduh kartu:', error);
                        alert('Gagal mengunduh kartu. Pastikan semua media dimuat dengan benar dan coba lagi.');
                        // Show download buttons and warning again if an error occurs
                        downloadCardBtn.classList.remove('hidden');
                        downloadWarning.classList.remove('hidden');
                        const currentSelectedSource = document.querySelector('input[name="mediaSource"]:checked').value;
                        if (selectedMediaData.type === 'video' && (currentSelectedSource === 'pexels_video' || currentSelectedSource === 'local')) {
                             downloadOriginalVideoBtn.classList.remove('hidden');
                        }
                    });
                }, 100); // 100ms delay
            });

            // Event listener for download Original Video button
            downloadOriginalVideoBtn.addEventListener('click', () => {
                if (selectedMediaData.url && selectedMediaData.type === 'video') {
                    // Create a temporary link element
                    const link = document.createElement('a');
                    link.href = selectedMediaData.url;
                    // Suggest a filename. Pexels URLs often end with .mp4 or similar.
                    // We can try to extract it or just suggest a generic name.
                    const filename = selectedMediaData.url.split('/').pop().split('?')[0] || `pexels_video_${new Date().getTime()}.mp4`;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click(); // Programmatically click the link to trigger download
                    document.body.removeChild(link);
                } else {
                    alert('Tidak ada video Pexels atau video lokal yang dipilih untuk diunduh.');
                }
            });
        });
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registered: ', registration.scope);
                    })
                    .catch(registrationError => {
                        console.log('ServiceWorker registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
